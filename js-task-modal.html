<!--
  MyTask
  https://github.com/blueshooterX/MyTask
  
  Copyright (c) 2026 blueshooterX
  Licensed under the MIT License.
-->

<script>
    /**
     * Task Modal Logic
     */

    let openedTaskData = null;

    function setupTaskModal() {
        // Modal events
        const modal = document.getElementById('taskModal');
        const closeModal = () => modal.classList.remove('show');

        document.querySelector('.close-modal').onclick = closeModal;
        document.querySelector('.cancel-btn').onclick = closeModal;

        // Close on ESC key
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('show')) {
                closeModal();
            }
        });

        document.getElementById('taskForm').onsubmit = (e) => {
            e.preventDefault();
            saveCurrentTask();
        };

        document.getElementById('deleteTaskBtn').onclick = () => {
            if (confirm('このタスクを削除しますか？')) {
                deleteCurrentTask();
            }
        };

        // Color Picker Logic (integrated with RichTextEditor)
        const colorBtn = document.getElementById('colorBtn');
        const colorMenu = document.getElementById('colorMenu');

        colorBtn.onclick = (e) => {
            e.preventDefault();
            colorMenu.classList.toggle('show');
        };

        document.querySelectorAll('.color-swatch').forEach(swatch => {
            swatch.onclick = (e) => {
                const color = swatch.dataset.color;
                RichTextEditor.applyColor('editor', color);
                colorMenu.classList.remove('show');
                colorBtn.querySelector('.color-bar').style.background = color;
            };
        });

        window.addEventListener('click', (e) => {
            if (!colorBtn.contains(e.target)) colorMenu.classList.remove('show');
        });
    }

    function openModal(task = null) {
        const form = document.getElementById('taskForm');
        const modal = document.getElementById('taskModal');
        const title = document.getElementById('modalTitle');

        form.reset();
        RichTextEditor.clear('editor');
        document.getElementById('deleteTaskBtn').style.display = task ? 'block' : 'none';

        if (task) {
            title.innerText = 'タスク編集';
            document.getElementById('taskId').value = task.id;
            document.getElementById('taskGroupInput').value = task.group;
            document.getElementById('taskPriorityInput').value = task.priority;
            document.getElementById('taskTitleInput').value = task.title;
            RichTextEditor.setHtml('editor', task.contentHtml);
            document.getElementById('taskDueDateInput').value = task.dueDate ? task.dueDate.split('T')[0] : '';
            document.getElementById('taskStatusInput').value = task.status;

            // Keep original data for change detection
            openedTaskData = {
                group: task.group,
                priority: task.priority,
                title: task.title,
                contentHtml: task.contentHtml,
                dueDate: task.dueDate ? task.dueDate.split('T')[0] : '',
                status: task.status
            };
        } else {
            title.innerText = '新規タスク追加';
            document.getElementById('taskId').value = '';
            openedTaskData = null;
        }

        modal.classList.add('show');
    }

    function saveCurrentTask() {
        const id = document.getElementById('taskId').value;
        const task = {
            id: id,
            group: document.getElementById('taskGroupInput').value,
            priority: document.getElementById('taskPriorityInput').value,
            title: document.getElementById('taskTitleInput').value,
            contentHtml: RichTextEditor.getHtml('editor'),
            contentRaw: RichTextEditor.getRawText('editor'),
            richTextData: RichTextEditor.getRichTextData('editor'),
            dueDate: document.getElementById('taskDueDateInput').value,
            status: document.getElementById('taskStatusInput').value,
            _contentModified: !openedTaskData || RichTextEditor.getHtml('editor') !== openedTaskData.contentHtml
        };

        // If nothing changed, just close modal
        if (openedTaskData &&
            task.group === openedTaskData.group &&
            task.priority === openedTaskData.priority &&
            task.title === openedTaskData.title &&
            task.contentHtml === openedTaskData.contentHtml &&
            task.dueDate === openedTaskData.dueDate &&
            task.status === openedTaskData.status) {
            document.getElementById('taskModal').classList.remove('show');
            return;
        }

        // --- Optimistic Update ---
        const originalTasks = JSON.parse(JSON.stringify(state.tasks));

        if (id) {
            // Edit mode: Update existing task in state
            const index = state.tasks.findIndex(t => t.id == id);
            if (index !== -1) {
                state.tasks[index] = { ...state.tasks[index], ...task };
            }
        } else {
            // New mode: Prepend temporary task
            const tempTask = {
                ...task,
                id: 'temp_' + Date.now(),
                no: 0 // Will be corrected by refresh
            };
            state.tasks.unshift(tempTask);
        }

        renderBoard();
        document.getElementById('taskModal').classList.remove('show');

        // Background save
        google.script.run
            .withSuccessHandler((res) => {
                // If it was a new task, we need the real ID for subsequent operations
                if (!id && res.id) {
                    const t = state.tasks.find(t => t.id.toString().startsWith('temp_'));
                    if (t) t.id = res.id;
                }
                refreshData(true); // Silent sync
            })
            .withFailureHandler(err => {
                // Rollback on failure
                state.tasks = originalTasks;
                renderBoard();
                handleError(err);
            })
            .saveTask(task);
    }

    function deleteCurrentTask() {
        const id = document.getElementById('taskId').value;
        showLoading('loading-overlay', true);
        google.script.run
            .withSuccessHandler(() => {
                document.getElementById('taskModal').classList.remove('show');
                refreshData();
            })
            .withFailureHandler(handleError)
            .deleteTask(id);
    }
</script>