<!--
  MyTask
  https://github.com/blueshooterX/MyTask
  
  Copyright (c) 2026 blueshooterX
  Licensed under the MIT License.
-->

<script>
    /**
     * Main Client Controller
     */

    const state = {
        tasks: [],
        mapping: {},
        filter: { group: '', priority: '' },
        columnSort: {
            '未着手': 'default',
            '実施中': 'default',
            '保留': 'default',
            '完了': 'default'
        },
        showDetail: false,
        showDone: false
    };

    // Initial Load
    window.onload = () => {
        RichTextEditor.init('editor', 'editorToolbar');
        setupEventListeners();
        setupSortable();
        setupResizers();
        setupTaskModal();

        // Initial UI State check
        updateDoneVisibility();
        updateDetailButton();

        // Load Data and Settings
        refreshData(); // handles showLoading internally

        google.script.run.withSuccessHandler(settings => {
            state.mapping = settings.mapping;
            document.getElementById('appVersion').innerText = settings.version || '';
        }).getSettings();
    };

    function initialize(data) {
        state.tasks = data;
        updateDataLists();
        renderBoard();
    }

    function refreshData(silent = false) {
        if (!silent) showLoading('loading-overlay', true);
        google.script.run
            .withSuccessHandler(data => {
                initialize(data);
                showLoading('loading-overlay', false);
            })
            .withFailureHandler(handleError)
            .getData();
    }

    function updateDataLists() {
        const groups = [...new Set(state.tasks.map(t => t.group).filter(Boolean))];
        const filterSelect = document.getElementById('filterGroup');
        const datalist = document.getElementById('groupOptions');

        // Filter HTML
        const currentFilter = filterSelect.value;
        filterSelect.innerHTML = '<option value="">全グループ</option>' +
            groups.map(g => `<option value="${g}" ${g === currentFilter ? 'selected' : ''}>${g}</option>`).join('');

        // Modal Input Candidates
        datalist.innerHTML = groups.map(g => `<option value="${g}">`).join('');
    }

    function setupEventListeners() {
        // Filter
        document.getElementById('filterGroup').onchange = (e) => {
            state.filter.group = e.target.value;
            renderBoard();
        };
        document.getElementById('filterPriority').onchange = (e) => {
            state.filter.priority = e.target.value;
            renderBoard();
        };

        // Column Sort
        document.querySelectorAll('.column-sort').forEach(sel => {
            sel.onchange = (e) => {
                const status = e.target.dataset.status;
                state.columnSort[status] = e.target.value;
                renderBoard();
            };
        });

        // Toggle Detail
        window.updateDetailButton = () => {
            const btn = document.getElementById('toggleDetailBtn');
            if (state.showDetail) {
                btn.innerText = '詳細：表示';
                btn.classList.add('primary');
                btn.classList.remove('secondary');
            } else {
                btn.innerText = '詳細：非表示';
                btn.classList.remove('primary');
                btn.classList.add('secondary');
            }
        };
        document.getElementById('toggleDetailBtn').onclick = () => {
            state.showDetail = !state.showDetail;
            updateDetailButton();
            renderBoard();
        };

        // Toggle Done Column
        const doneColumn = document.querySelector('.kanban-column[data-status="完了"]');

        window.updateDoneVisibility = () => {
            const btn = document.getElementById('toggleDoneBtn');
            // Reset widths
            document.querySelectorAll('.kanban-column').forEach(col => {
                col.style.width = '';
                col.style.flex = '1 1 0';
            });

            if (state.showDone) {
                doneColumn.classList.remove('hidden');
                btn.innerText = '完了：表示';
                btn.classList.add('primary');
                btn.classList.remove('secondary');
            } else {
                doneColumn.classList.add('hidden');
                btn.innerText = '完了：非表示';
                btn.classList.remove('primary');
                btn.classList.add('secondary');
            }
        };

        document.getElementById('toggleDoneBtn').onclick = () => {
            state.showDone = !state.showDone;
            window.updateDoneVisibility();
        };

        // Add Task
        document.getElementById('addTaskBtn').onclick = () => openModal();

        // Import Google Tasks
        document.getElementById('importTasksBtn').onclick = () => {
            document.getElementById('dropdownMenu').classList.remove('show');
            showLoading('loading-overlay', true);
            google.script.run
                .withSuccessHandler(res => {
                    refreshData();
                    alert(`${res.count} 件のタスクを抽出しました。`);
                })
                .withFailureHandler(handleError)
                .importFromGoogleTasks();
        };

        // Menu Toggle
        const menuTrigger = document.getElementById('menuTrigger');
        const dropdownMenu = document.getElementById('dropdownMenu');
        menuTrigger.onclick = (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
        };
        window.onclick = () => {
            dropdownMenu.classList.remove('show');
        };
    }

    function handleError(err) {
        showLoading('loading-overlay', false);
        alert('Error: ' + err.message);
        console.error(err);
    }
</script>