# 開発指示書: MyTask

## 0. 事前準備

### 1. スプレッドシートの作成
新規スプレッドシートを作成し、以下の2つのシートを用意します。

**A. MasterData シート**
- アプリケーションへのアクセス権を持つユーザーを管理します。
- A列に許可するメールアドレスを入力してください。
  - 例: `A1: user@example.com`

**B. TaskData シート**
- タスクデータを保存するシートです。1行目に以下のヘッダーを設定してください。
  （アプリ初回起動時に自動生成されますが、手動で作成しておくと確実です）
  - A列: ID
  - B列: 表示順
  - C列: タスクグループ
  - D列: タスクタイトル
  - E列: タスク内容
  - F列: タスク期限
  - G列: タスク優先度
  - H列: ステータス
  - I列: ラベル

### 2. スプレッドシートIDの取得
作成したスプレッドシートのURLからIDをコピーします。
`https://docs.google.com/spreadsheets/d/[この部分がID]/edit`

### 3. 初期設定
`AppConfig.js` (手動デプロイの場合は `Code.gs` 内の同箇所) の以下の行を、コピーしたIDに書き換えてください。
```javascript
const CONFIG = {
    SPREADSHEET_ID: 'ここにコピーしたIDを貼り付け',
    // ...
```

## 1. プロジェクト概要
- **目的**: Google Apps Script (GAS) と Google Sheets をバックエンドにした、軽量なタスク管理アプリケーションの開発。
- **データソース**: スプレッドシート（TaskData, MasterData）を使用。

## 2. カラム構成 (日本語表記)
1. **未着手 (Backlog)**: 新規および未着手のタスク
2. **実施中 (WIP)**: 現在進行中のタスク
3. **保留 (Pending)**: 何らかの理由で停止しているタスク
4. **完了 (Done)**: 完了したタスク
- **タスクカード**: タスクグループ名称、タスクタイトル、タスク内容、タスク期限、タスク優先度、ラベルを表示。

## 3. 主要機能
- **ドラッグ＆ドロップ**: カラム間での移動および同一カラム内での並び替え。
  - **装飾保持**: 移動や並び替えを行っても、スプレッドシート上の文字色や太字などの装飾が喪失しないよう `RichTextValue` を維持して保存。
- **フィルタ機能**: ヘッダー右側で「タスクグループ」「優先度」による絞り込みが可能。
- **ソート機能**: 各カラムヘッダーで「デフォルト」「優先度」「タスクグループ」「期限」による並び替えが可能。
- **新規タスク追加**: 「新規タスク追加」ボタンからモーダル形式でタスクを作成可能。
- **タスク編集**: カードをクリックして内容（タスクタイトル、タスク内容、タスクグループ、期限、優先度、ステータス）を編集。
- **タスク削除**: カードをクリックして内容（タスクタイトル、タスク内容、タスクグループ、期限、優先度、ステータス）を編集。
- **リッチテキスト同期 (双方向)**:
  - **読込**: スプレッドシートの「タスク内容」セルの装飾（太字、取り消し線、部分的な文字色）をカンバンボードに反映。
  - **保存 (クリーン・マッピング)**: エディタで編集した HTML から、スプレッドシートの `RichTextValue` へ変換。ブラウザ特有の `div` 構造や入れ子タグ、改行タグ (`<br>`) を 1 文字の狂いもなく正確にインデックス同期して保存。
- **アクセス制御**: `MasterData` シートに登録されたメールアドレスのユーザーのみがアクセス可能。

## 4. UI/UX 特徴
- **レスポンシブ・グリッド**: カラム幅に応じてカードがタイル状に配置される。
- **カラムリサイズ**: カラム間の境界線をドラッグして幅を自由に変更可能。
- **詳細表示切り替え**: 右上の「詳細：表示/非表示」ボタンで全カードの内容を一括表示切替。表示中はボタンがプライマリカラーで強調される。
- **完了列の表示切替**: 右上の「完了：表示/非表示」ボタンで完了列の表示・非表示を切り替え可能。直感的なラベルと色（表示時は色付き、非表示時はグレー）で状態を表現。
- **日本語化**: UIラベル、ステータス、優先度をすべて日本語で統一（内部的には英語キーとマッピング）。

- **Google Task 抽出機能**:
  - ヘッダー右上のハンバーガーメニュー（︙）内に格納。
  - Google カレンダーのタスクをスプレッドシートへ一括抽出可能。
  - 同一タイトルのタスクは重複して抽出しないようガード。
  - 抽出されたタスクは「GoogleTasks」グループ、優先度「中」として「未着手」カラムに追加。

- **タスクラベル機能**:
  - 各タスクカードに★アイコンを配置。クリックで ⭐ → ⚠️ → 💥 → 🩷 → ★（グレー）とローテーション。
  - ラベル状態はスプレッドシートに保存され、視覚的な分類に活用可能。

- **タスク完了チェック機能**:
  - 各タスクカードに Material Icons の `check_circle` アイコンを配置。
  - 未完了タスク: グレーのチェックアイコン。クリックで完了列に移動。
  - 完了タスク: 緑色のチェックアイコン。クリックで実施中列に戻る。
  - チェック操作時に視覚的なアニメーション（緑色フラッシュ、フェードアウト/イン）を表示。

- **アニメーション効果**:
  - **完了時**: カードが緑色に光りながら拡大→縮小・フェードアウト（0.7秒）→完了列で緑色背景からフェードイン（0.5秒）。
  - **実施中に戻す時**: 完了列でフェードアウト→実施中列で緑色背景からフェードイン。
  - 移動が視覚的に分かりやすく、ユーザー体験を向上。

- **カラム内スクロール**:
  - タスクが多い場合、カード内容を圧縮せず、カラム内で独立してスクロール可能。
  - グリッドレイアウトの各行が内容に応じた高さに自動調整。

- **優先度ラインの強調**:
  - タスクカード左端の優先度表示ラインを従来の 3px から **6px** に太くし、一目で重要度を判別できるように改善。

- **URLリンクの自動アイコン化**:
  - タスク内容に含まれるURLを自動検出し、直前に特定のアイコン（Gmail, Drive, Calendar, Meet 等）を付与してリンクとして表示。
  - Driveリンクには「フォルダ」アイコンを採用し、直感的な視認性を確保。
  - 詳細を閉じたプレビュー状態でも、URLの種類を示すアイコンが表示される。

- **ハンバーガーメニュー (︙)**:
  - 利用頻度の低い機能（Google Task 抽出等）をメニュー内に整理し、ヘッダーの省スペース化と利便性を両立。

- **バージョン表示**:
  - アプリタイトルの横にバージョン番号（例: `v1.1.0`）を表示。`AppConfig.js` で一元管理。

- **リッチテキストエディタ**:
  - **ツールバー**: 太字・取り消し線・文字色・箇条書きボタンを搭載。
  - **カラーセレクター**: 白背景で視認性の高い 8 色（黒、赤、青、緑、橙、紫、桃、灰）を厳選したドロップダウン形式を採用。
  - **フォーカス維持**: ツールバー操作時に直前のエディタフォーカスを維持・復元し、スムーズな編集を可能にする。

## 5. データ・システム構造
- **スプレッドシート列構成 (TaskData)**:
  1. ID (A列): 不変の一意識別子
  2. 表示順 (B列): カンバン上の並び順
  3. タスクグループ (C列): グループ名
  4. タスクタイトル (D列): タスク名
  5. タスク内容 (E列): 詳細内容（RichTextValue）
  6. タスク期限 (F列): 期限日
  7. タスク優先度 (G列): 高/中/低
  8. ステータス (H列): 未着手/実施中/保留/完了
  9. ラベル (I列): ラベルアイコン（⭐/⚠️/💥/🩷/空）

- **IDとNoの分離**:
  - **ID**: 不変の一意識別子（新規追加時に自動採番）。
  - **No**: 表示順序（カンバンでの並び順に基づきスプレッドシートの「表示順」列を更新）。
- **日本語マッピング**:
  - スプレッドシート上の日本語（高/中/低、未着手/実施中等）を、プログラム内部の英語キーやCSSクラス（high/middle/low等）と同期して管理。
- **RichTextValueへの変換エンジン (`Code.js`)**:
  - **スタック解析**: 入れ子になったタグを階層構造として解析。
  - **文字単位スタイル合成**: 各文字に適用されたスタイルを合成し、同等のスタイル範囲（Run）を特定して適用。
  - **RGBパース**: ブラウザの `styleWithCSS` が生成する `rgb(r, g, b)` 形式を正確に Hex カラーへ変換。
- **プロジェクト名称**: `MyTask` として管理。

## 6. デプロイ手順

### 方法A: 簡単デプロイ (手動コピー＆ペースト)
`clasp` を使用していないユーザー向けの、最も簡単な方法です。

1. **ファイルをまとめる**:
   ターミナル（PowerShell等）で以下のコマンドを実行します。
   ```pwsh
   node bundler.js
   ```
   ※プロジェクト内の複数のファイルが `dist` フォルダ内の2つのファイルに集約されます。

2. **GASエディタに貼り付ける**:
   Google Apps Script エディタを開き、以下の2つのファイルを作成（または上書き）して、`dist` 内の中身を貼り付けます。
   - `Code.gs`: `dist/Code.gs` の内容を貼り付け
   - `index.html`: `dist/index.html` の内容を貼り付け

3. **プロジェクト設定ファイル (appsscript.json) の更新**:
   Google Tasks API を使用するため、設定ファイルの更新が必要です。
   1. GASエディタの左サイドバー「プロジェクトの設定（歯車アイコン）」を開き、「「appsscript.json」マニフェスト ファイルをエディタで表示する」にチェックを入れます。
   2. エディタに戻り、表示された `appsscript.json` に以下の内容を上書きします。
   ```json
   {
     "timeZone": "Asia/Tokyo",
     "dependencies": {
       "enabledAdvancedServices": [{
         "userSymbol": "Tasks",
         "serviceId": "tasks",
         "version": "v1"
       }]
     },
     "exceptionLogging": "STACKDRIVER",
     "runtimeVersion": "V8",
     "webapp": {
       "executeAs": "USER_DEPLOYING",
       "access": "ANYONE"
     }
   }
   ```

4. **保存とデプロイ**:
   GASエディタ上で「保存」し、「新しいデプロイ」を行ってください。

### 方法B: claspによるデプロイ (開発者向け)
開発環境で変更を行った後、以下のコマンドで Web アプリを更新します。

1. **コードの同期**:
   ```pwsh
   clasp push -f
   ```
2. **新バージョンの作成**:
   ```pwsh
   clasp version "変更内容の説明"
   ```
   ※実行後に表示されるバージョン番号を確認します。

3. **デプロイの更新**:
   ```pwsh
   clasp deploy --versionNumber [バージョン番号] --deploymentId AKfycbxDJ2LqgQF6Gx_RLzkWF85cU1KQkef3Hitq3kRzthgQXXQOk-diyDaf1XAQIL0f5k7M-w
   ```

## 7. その他
- **技術スタック**: GAS (htmlService), Sortable.js, Vanilla CSS.

