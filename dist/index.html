<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
<!-- --- START css.html --- -->
<style>
    :root {
        --primary: #4F46E5;
        --primary-hover: #4338CA;
        --bg-main: #F8FAFC;
        --bg-card: #FFFFFF;
        --text-main: #1E293B;
        --text-muted: #64748B;
        --border: #E2E8F0;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --radius: 12px;

        --priority-high: #FEE2E2;
        --priority-high-text: #EF4444;
        --priority-middle: #FEF3C7;
        --priority-middle-text: #F59E0B;
        --priority-low: #F0F9FF;
        --priority-low-text: #3B82F6;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-main);
        color: var(--text-main);
        line-height: 1.5;
        overflow-x: hidden;
    }

    h1,
    h2,
    .outfit {
        font-family: 'Outfit', sans-serif;
    }

    #app {
        display: flex;
        flex-direction: column;
        height: 100vh;
    }

    header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        background: white;
        border-bottom: 1px solid var(--border);
        z-index: 10;
        min-height: 48px;
        height: auto;
        flex-shrink: 0;
        flex-wrap: wrap;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    header h1 {
        font-size: 1.2rem;
        color: var(--primary);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .version-tag {
        font-size: 0.7rem;
        font-weight: 400;
        color: var(--text-muted);
        background: var(--bg-main);
        padding: 0.1rem 0.4rem;
        border-radius: 4px;
        border: 1px solid var(--border);
    }

    .filter-group {
        display: flex;
        gap: 0.5rem;
    }

    select,
    input[type="text"],
    textarea {
        padding: 0.4rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.85rem;
        outline: none;
        transition: border-color 0.2s;
    }

    select:focus {
        border-color: var(--primary);
    }

    .header-right {
        display: flex;
        gap: 0.5rem;
    }

    .btn {
        padding: 0.4rem 1rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        font-size: 0.85rem;
    }

    .btn.primary {
        background-color: var(--primary);
        color: white;
    }

    .btn.primary:hover {
        background-color: var(--primary-hover);
    }

    .btn.secondary {
        background-color: var(--bg-main);
        color: var(--text-main);
        border: 1px solid var(--border);
    }

    .btn.secondary:hover {
        background-color: var(--border);
    }

    /* Menu & Hamburger */
    .menu-container {
        position: relative;
        display: inline-block;
    }

    .menu-trigger {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0.4rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .menu-trigger:hover {
        background: var(--bg-main);
        color: var(--primary);
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: var(--shadow-md);
        min-width: 180px;
        z-index: 1000;
        display: none;
        padding: 0.5rem 0;
        margin-top: 0.5rem;
    }

    .dropdown-menu.show {
        display: block;
    }

    .dropdown-item {
        padding: 0.6rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-main);
        text-decoration: none;
        font-size: 0.85rem;
        cursor: pointer;
        transition: background 0.2s;
    }

    .dropdown-item:hover {
        background: var(--bg-main);
        color: var(--primary);
    }

    .dropdown-item .material-icons {
        font-size: 1.1rem;
    }

    main {
        flex: 1;
        padding: 0.5rem;
        overflow: hidden;
        /* Scroll handled by columns/grid */
        display: flex;
        flex-direction: column;
    }

    .kanban-grid {
        display: flex;
        flex-direction: row;
        gap: 0;
        height: 100%;
        width: 100%;
    }

    .kanban-column {
        background: #F1F5F9;
        border-radius: var(--radius);
        /* Flex grow 1 to fill space, shrink 1, base 0 for equal distribution or resizing */
        flex: 1 1 0;
        min-width: 250px;
        display: flex;
        flex-direction: column;
        max-height: 100%;
        border: 1px solid rgba(0, 0, 0, 0.05);
        margin-right: 2px;
        transition: flex-grow 0.3s ease;
    }

    .kanban-column.hidden {
        flex: 0 0 0 !important;
        min-width: 0 !important;
        width: 0 !important;
        overflow: hidden;
        border: none;
        margin: 0;
        padding: 0;
    }

    .kanban-column.hidden+.resizer {
        display: none;
    }

    .column-header {
        padding: 0.3rem 0.6rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        height: 32px;
    }

    .column-header h2 {
        font-size: 0.9rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .column-header .count {
        background: var(--border);
        padding: 0.05rem 0.4rem;
        border-radius: 12px;
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .column-sort {
        font-size: 0.7rem;
        padding: 0.1rem 0.3rem;
    }

    .resizer {
        width: 4px;
        /* Thinner resizer */
        cursor: col-resize;
        flex-shrink: 0;
        z-index: 5;
        background: transparent;
    }

    .resizer:hover {
        background: rgba(79, 70, 229, 0.3);
    }

    .task-list {
        flex: 1;
        padding: 0.4rem;
        overflow-y: auto;
        min-height: 0;
        /* Crucial for scrolling inside flex column */

        /* Grid Layout for Multi-Column Tasks */
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        grid-auto-rows: min-content;
        /* Each row adjusts to content height */
        gap: 0.4rem;
        align-content: start;
    }

    /* Task Card */
    .task-card {
        background: var(--bg-card);
        border-radius: 6px;
        padding: 0.4rem 0.6rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        cursor: grab;
        border: 1px solid rgba(226, 232, 240, 0.8);
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: transform 0.2s, box-shadow 0.2s;
        flex-shrink: 0;
        /* Prevent squashing in flex containers */
        height: auto;
        /* Ensure height adjusts to content */
    }

    .task-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 6px;
        height: 100%;
    }

    .task-card.priority-high::before {
        background: #ef4444;
    }

    .task-card.priority-middle::before {
        background: #f59e0b;
    }

    .task-card.priority-low::before {
        background: #22c55e;
    }

    .task-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
        border-color: var(--primary);
    }

    /* Card Header Row: Group, Title, Date */
    .card-header-row {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        margin-bottom: 0.1rem;
        width: 100%;
    }

    .card-label {
        cursor: pointer;
        font-size: 1rem;
        color: #ddd;
        /* Inactive gray */
        display: flex;
        align-items: center;
        transition: transform 0.1s;
    }

    .card-label.active {
        color: inherit;
        /* Use emoji color */
        opacity: 1;
    }

    .card-label:hover {
        transform: scale(1.2);
    }

    .card-check {
        cursor: pointer;
        color: #e2e8f0;
        /* Grayed out */
        margin-left: 0.2rem;
        transition: color 0.2s;
        font-size: 1.25rem !important;
        /* Override standard material size if needed */
        user-select: none;
    }

    .card-check.completed {
        color: #22c55e !important;
    }

    .task-card.completing {
        pointer-events: none;
        z-index: 100 !important;
        transition: none !important;
        animation: completeTask 0.7s ease-in-out forwards;
    }

    @keyframes completeTask {
        0% {
            transform: scale(1);
            background: var(--bg-card);
            opacity: 1;
        }

        30% {
            transform: scale(1.05);
            background: #dcfce7;
            border-color: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
        }

        100% {
            transform: scale(0.1);
            opacity: 0;
            margin-bottom: -50px;
        }
    }

    .task-card.appearing {
        animation: appearTask 0.5s ease-out forwards;
    }

    @keyframes appearTask {
        0% {
            transform: scale(0.8);
            opacity: 0;
            background: #dcfce7;
            border-color: #22c55e;
        }

        50% {
            background: #dcfce7;
            border-color: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
        }

        100% {
            transform: scale(1);
            opacity: 1;
            background: var(--bg-card);
            border-color: rgba(226, 232, 240, 0.8);
        }
    }

    .card-check:hover {
        color: #22c55e;
        /* Green on hover */
    }

    .card-group {
        display: inline-block;
        font-size: 0.65rem;
        font-weight: 700;
        padding: 0.05rem 0.3rem;
        border-radius: 3px;
        color: white;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .card-title {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--text-main);
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
    }

    .card-due {
        font-size: 0.75rem;
        font-weight: 500;
        color: #475569;
        /* Darker than text-muted for better visibility */
        white-space: nowrap;
        flex-shrink: 0;
    }

    .card-due.overdue {
        color: #ef4444;
        font-weight: 600;
    }

    /* Card Content Preview */
    .card-preview {
        font-size: 0.75rem;
        color: var(--text-muted);
        line-height: 1.3;
        margin-top: 0.1rem;

        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .card-content {
        display: none;
    }

    /* Show Detail Mode (if toggled) */
    .show-detail .card-content {
        display: block !important;
        font-size: 0.85rem;
        color: var(--text-main);
        white-space: pre-wrap;
        margin-top: 0.5rem;
        border-top: 1px solid var(--border);
        padding-top: 0.5rem;
    }

    .show-detail .card-preview {
        display: none !important;
    }

    /* Card Links */
    .url-inline-link {
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
        background: var(--bg-main);
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 0 0.3rem;
        color: var(--primary);
        text-decoration: none;
        font-size: 0.85rem;
        transition: all 0.2s;
        margin: 0 0.1rem;
        vertical-align: middle;
    }

    .url-inline-link:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .url-inline-link .material-icons {
        font-size: 1rem;
    }

    .preview-inline-icon {
        font-size: 0.9rem !important;
        vertical-align: middle;
        margin-right: 0.2rem;
        color: var(--text-muted);
    }

    /* Modal & Overlay */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .overlay.show {
        visibility: visible;
        opacity: 1;
    }

    .loader {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        width: 32px;
        height: 32px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    @media (max-width: 768px) {
        header {
            flex-direction: column;
            height: auto;
            gap: 0.5rem;
            padding: 0.5rem;
        }

        .header-left {
            width: 100%;
            justify-content: space-between;
        }

        .header-right {
            width: 100%;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .kanban-grid {
            flex-direction: column;
            overflow-y: auto;
        }

        .kanban-column {
            width: 100%;
            min-width: 0;
            margin-bottom: 1rem;
        }

        .resizer {
            display: none;
        }
    }
</style>
<!-- --- END css.html --- -->

</head>

<body>
    <div id="app">
        <header>
            <div class="header-left">
                <h1>MyTask <span id="appVersion" class="version-tag"></span></h1>
                <div class="filter-group">
                    <select id="filterGroup">
                        <option value="">ÂÖ®„Ç∞„É´„Éº„Éó</option>
                    </select>
                    <select id="filterPriority">
                        <option value="">ÂÖ®ÂÑ™ÂÖàÂ∫¶</option>
                        <option value="È´ò">È´ò</option>
                        <option value="‰∏≠">‰∏≠</option>
                        <option value="‰Ωé">‰Ωé</option>
                    </select>
                </div>
            </div>
            <div class="header-right">
                <button id="toggleDoneBtn" class="btn secondary">ÂÆå‰∫ÜÔºöÈùûË°®Á§∫</button>
                <button id="toggleDetailBtn" class="btn secondary">Ë©≥Á¥∞ÔºöÈùûË°®Á§∫</button>
                <button id="addTaskBtn" class="btn primary">Êñ∞Ë¶è„Çø„Çπ„ÇØËøΩÂä†</button>
                <div class="menu-container">
                    <button id="menuTrigger" class="menu-trigger">
                        <span class="material-icons">more_vert</span>
                    </button>
                    <div id="dropdownMenu" class="dropdown-menu">
                        <div id="importTasksBtn" class="dropdown-item">
                            <span class="material-icons">download</span>
                            <span>Google Task ÊäΩÂá∫</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <div id="kanban-container" class="kanban-grid">
                <div class="kanban-column" data-status="Êú™ÁùÄÊâã">
                    <div class="column-header">
                        <h2>Êú™ÁùÄÊâã <span class="count">0</span></h2>
                        <select class="column-sort" data-status="Êú™ÁùÄÊâã">
                            <option value="default">Ë°®Á§∫È†Ü</option>
                            <option value="priority">ÂÑ™ÂÖàÂ∫¶</option>
                            <option value="group">„Ç∞„É´„Éº„Éó</option>
                            <option value="dueDate">ÊúüÈôê</option>
                        </select>
                    </div>
                    <div class="task-list" id="backlog"></div>
                </div>
                <div class="resizer"></div>

                <div class="kanban-column" data-status="ÂÆüÊñΩ‰∏≠">
                    <div class="column-header">
                        <h2>ÂÆüÊñΩ‰∏≠ <span class="count">0</span></h2>
                        <select class="column-sort" data-status="ÂÆüÊñΩ‰∏≠">
                            <option value="default">Ë°®Á§∫È†Ü</option>
                            <option value="priority">ÂÑ™ÂÖàÂ∫¶</option>
                            <option value="group">„Ç∞„É´„Éº„Éó</option>
                            <option value="dueDate">ÊúüÈôê</option>
                        </select>
                    </div>
                    <div class="task-list" id="wip"></div>
                </div>
                <div class="resizer"></div>

                <div class="kanban-column" data-status="‰øùÁïô">
                    <div class="column-header">
                        <h2>‰øùÁïô <span class="count">0</span></h2>
                        <select class="column-sort" data-status="‰øùÁïô">
                            <option value="default">Ë°®Á§∫È†Ü</option>
                            <option value="priority">ÂÑ™ÂÖàÂ∫¶</option>
                            <option value="group">„Ç∞„É´„Éº„Éó</option>
                            <option value="dueDate">ÊúüÈôê</option>
                        </select>
                    </div>
                    <div class="task-list" id="pending"></div>
                </div>
                <div class="resizer"></div>

                <div class="kanban-column" data-status="ÂÆå‰∫Ü">
                    <div class="column-header">
                        <h2>ÂÆå‰∫Ü <span class="count">0</span></h2>
                        <select class="column-sort" data-status="ÂÆå‰∫Ü">
                            <option value="default">Ë°®Á§∫È†Ü</option>
                            <option value="priority">ÂÑ™ÂÖàÂ∫¶</option>
                            <option value="group">„Ç∞„É´„Éº„Éó</option>
                            <option value="dueDate">ÊúüÈôê</option>
                        </select>
                    </div>
                    <div class="task-list" id="done"></div>
                </div>
            </div>
        </main>

        <!-- Modals -->
        
<!-- --- START modal.html --- -->
<!-- Task Editor Modal -->
<div id="taskModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Êñ∞Ë¶è„Çø„Çπ„ÇØËøΩÂä†</h2>
            <span class="close-modal">&times;</span>
        </div>
        <form id="taskForm">
            <input type="hidden" id="taskId">

            <div class="form-row">
                <div class="form-group">
                    <label for="taskGroup">„Çø„Çπ„ÇØ„Ç∞„É´„Éº„Éó</label>
                    <input type="text" id="taskGroupInput" list="groupOptions" placeholder="„Ç∞„É´„Éº„ÉóÂêç„ÇíÂÖ•Âäõ„Åæ„Åü„ÅØÈÅ∏Êäû">
                    <datalist id="groupOptions"></datalist>
                </div>
                <div class="form-group">
                    <label for="taskPriorityInput">ÂÑ™ÂÖàÂ∫¶</label>
                    <select id="taskPriorityInput">
                        <option value="È´ò">È´ò</option>
                        <option value="‰∏≠" selected>‰∏≠</option>
                        <option value="‰Ωé">‰Ωé</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="taskTitleInput">„Çø„Çπ„ÇØ„Çø„Ç§„Éà„É´</label>
                <input type="text" id="taskTitleInput" required placeholder="„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ">
            </div>

            <div class="form-group">
                <label>„Çø„Çπ„ÇØÂÜÖÂÆπ („É™„ÉÉ„ÉÅ„ÉÜ„Ç≠„Çπ„Éà)</label>
                <div class="rich-editor-container">
                    <div class="toolbar" id="editorToolbar">
                        <button type="button" data-cmd="bold" title="Â§™Â≠ó"><b>B</b></button>
                        <button type="button" data-cmd="strikethrough" title="Âèñ„ÇäÊ∂à„ÅóÁ∑ö"><s>S</s></button>
                        <div class="color-picker">
                            <button type="button" class="color-btn" id="colorBtn">A<span
                                    class="color-bar"></span></button>
                            <div class="color-menu" id="colorMenu">
                                <div class="color-swatch" style="background:#000000" data-color="#000000"></div>
                                <div class="color-swatch" style="background:#ef4444" data-color="#ef4444"></div>
                                <div class="color-swatch" style="background:#3b82f6" data-color="#3b82f6"></div>
                                <div class="color-swatch" style="background:#22c55e" data-color="#22c55e"></div>
                                <div class="color-swatch" style="background:#f59e0b" data-color="#f59e0b"></div>
                                <div class="color-swatch" style="background:#a855f7" data-color="#a855f7"></div>
                                <div class="color-swatch" style="background:#ec4899" data-color="#ec4899"></div>
                                <div class="color-swatch" style="background:#6b7280" data-color="#6b7280"></div>
                            </div>
                        </div>
                        <button type="button" data-cmd="insertUnorderedList" title="ÁÆáÊù°Êõ∏„Åç">‚Ä¢</button>
                    </div>
                    <div id="editor" contenteditable="true"></div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="taskDueDateInput">ÊúüÈôê</label>
                    <input type="date" id="taskDueDateInput">
                </div>
                <div class="form-group">
                    <label for="taskStatusInput">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                    <select id="taskStatusInput">
                        <option value="Êú™ÁùÄÊâã">Êú™ÁùÄÊâã</option>
                        <option value="ÂÆüÊñΩ‰∏≠">ÂÆüÊñΩ‰∏≠</option>
                        <option value="‰øùÁïô">‰øùÁïô</option>
                        <option value="ÂÆå‰∫Ü">ÂÆå‰∫Ü</option>
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" id="deleteTaskBtn" class="btn secondary danger" style="display:none">ÂâäÈô§</button>
                <div style="flex:1"></div>
                <button type="button" class="btn secondary cancel-btn">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="submit" class="btn primary">‰øùÂ≠ò</button>
            </div>
        </form>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
        visibility: hidden;
        opacity: 0;
        transition: all 0.3s;
    }

    .modal-overlay.show {
        visibility: visible;
        opacity: 1;
    }

    .modal-content {
        background: white;
        width: 90%;
        max-width: 600px;
        border-radius: var(--radius);
        padding: 2rem;
        box-shadow: var(--shadow-md);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .close-modal {
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-muted);
    }

    .form-group {
        margin-bottom: 1.25rem;
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 0.4rem;
        color: var(--text-main);
    }

    .form-row {
        display: flex;
        gap: 1rem;
    }

    .form-row .form-group {
        flex: 1;
    }

    /* „É™„ÉÉ„ÉÅ„Ç®„Éá„Ç£„Çø */
    .rich-editor-container {
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
    }

    .toolbar {
        background: #f1f5f9;
        border-bottom: 1px solid var(--border);
        padding: 0.5rem;
        display: flex;
        gap: 0.25rem;
        align-items: center;
    }

    .toolbar button {
        width: 32px;
        height: 32px;
        border: 1px solid transparent;
        background: transparent;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .toolbar button:hover {
        background: #e2e8f0;
        border-color: var(--border);
    }

    #editor {
        min-height: 150px;
        max-height: 300px;
        padding: 1rem;
        outline: none;
        overflow-y: auto;
    }

    /* „Ç´„É©„Éº„Éî„ÉÉ„Ç´„Éº */
    .color-picker {
        position: relative;
    }

    .color-btn {
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .color-bar {
        width: 16px;
        height: 3px;
        background: black;
        margin-top: -2px;
    }

    .color-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 0.5rem;
        display: none;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        z-index: 10;
    }

    .color-menu.show {
        display: grid;
    }

    .color-swatch {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        cursor: pointer;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .color-swatch:hover {
        transform: scale(1.1);
    }

    .modal-footer {
        display: flex;
        gap: 1rem;
        padding-top: 1rem;
    }

    .btn.danger {
        color: #ef4444;
        border-color: #fecaca;
    }

    .btn.danger:hover {
        background-color: #fef2f2;
    }
</style>
<!-- --- END modal.html --- -->


        <div id="loading-overlay" class="overlay">
            <div class="loader"></div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <!-- Scripts -->
    
<!-- --- START js-ui-utils.html --- -->
<script>
    /**
     * UI Utilities (Reusable)
     */

    function generateColorFromHash(string) {
        if (!string) return '#94a3b8'; // default slate color
        const colors = [
            '#6366f1', '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#ec4899', '#8b5cf6', '#14b8a6',
            '#f97316', '#06b6d4', '#84cc16', '#d946ef', '#0ea5e9', '#22c55e', '#eab308', '#64748b'
        ];

        let hash = 0;
        for (let i = 0; i < string.length; i++) {
            hash = string.charCodeAt(i) + ((hash << 5) - hash);
            hash = hash & hash;
        }

        const index = Math.abs(hash) % colors.length;
        return colors[index];
    }

    function showLoading(elementId, show) {
        const el = document.getElementById(elementId);
        if (el) {
            el.classList.toggle('show', show);
        }
    }

    /**
     * Generic Column Resizer
     * @param {string} resizerSelector CSS selector for resizer elements
     * @param {string} columnSelector CSS selector for column elements (relative to resizer)
     * @param {HTMLElement} containerElement Container element
     */
    function setupColumnResizer(resizerSelector, columnSelector, containerElement) {
        const resizers = document.querySelectorAll(resizerSelector);
        const columns = document.querySelectorAll(columnSelector);
        if (!containerElement) return;

        // Initial width balance
        const totalGap = (resizers.length * 8) + 40;
        const initialWidth = (containerElement.offsetWidth - totalGap) / columns.length;
        columns.forEach(col => {
            if (initialWidth > 200) col.style.width = initialWidth + 'px';
        });

        resizers.forEach(resizer => {
            let startX, startWidth;
            const column = resizer.previousElementSibling;

            resizer.addEventListener('mousedown', e => {
                startX = e.pageX;
                startWidth = column.offsetWidth;

                const onMouseMove = (moveEvent) => {
                    const width = startWidth + (moveEvent.pageX - startX);
                    if (width > 100) {
                        column.style.flex = '0 0 auto'; // Disable flex to allow manual width
                        column.style.width = width + 'px';
                    }
                };
                const onMouseUp = () => {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    resizer.classList.remove('resizing');
                };
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                resizer.classList.add('resizing');
            });
        });
    }
</script>
<!-- --- END js-ui-utils.html --- -->

    
<!-- --- START js-rich-text-editor.html --- -->
<script>
    /**
     * Rich Text Editor Component (Reusable)
     */

    const RichTextEditor = {
        focusedRange: null,

        init: function (editorId, toolbarId) {
            const editor = document.getElementById(editorId);

            editor.addEventListener('blur', () => {
                const sel = window.getSelection();
                if (sel.rangeCount > 0) {
                    this.focusedRange = sel.getRangeAt(0);
                }
            });

            const buttons = document.querySelectorAll(`#${toolbarId} button[data-cmd]`);
            buttons.forEach(btn => {
                btn.onclick = (e) => {
                    e.preventDefault();
                    this.restoreFocus(editor);
                    const cmd = btn.dataset.cmd;
                    document.execCommand(cmd, false, null);
                };
            });
        },

        restoreFocus: function (editorElement) {
            editorElement.focus();
            if (this.focusedRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(this.focusedRange);
            }
        },

        applyColor: function (editorId, color) {
            const editor = document.getElementById(editorId);
            this.restoreFocus(editor);
            document.execCommand('foreColor', false, color);
        },

        getHtml: function (editorId) {
            return document.getElementById(editorId).innerHTML;
        },

        getRawText: function (editorId) {
            return document.getElementById(editorId).innerText;
        },

        setHtml: function (editorId, html) {
            document.getElementById(editorId).innerHTML = html;
        },

        clear: function (editorId) {
            document.getElementById(editorId).innerHTML = '';
        }
    };
</script>
<!-- --- END js-rich-text-editor.html --- -->

    
<!-- --- START js-kanban-view.html --- -->
<script>
    /**
     * Kanban View Logic
     */

    function renderBoard() {
        const containers = {
            'Êú™ÁùÄÊâã': document.getElementById('backlog'),
            'ÂÆüÊñΩ‰∏≠': document.getElementById('wip'),
            '‰øùÁïô': document.getElementById('pending'),
            'ÂÆå‰∫Ü': document.getElementById('done')
        };

        // Clear
        Object.values(containers).forEach(c => c.innerHTML = '');

        const filtered = state.tasks.filter(t => {
            const matchGroup = !state.filter.group || t.group === state.filter.group;
            const matchPriority = !state.filter.priority || t.priority === state.filter.priority;
            return matchGroup && matchPriority;
        });

        // Group by status
        const statusGroups = { 'Êú™ÁùÄÊâã': [], 'ÂÆüÊñΩ‰∏≠': [], '‰øùÁïô': [], 'ÂÆå‰∫Ü': [] };
        filtered.forEach(t => { if (statusGroups[t.status]) statusGroups[t.status].push(t); });

        Object.entries(statusGroups).forEach(([status, tasks]) => {
            const list = containers[status];
            const sortMode = state.columnSort[status];

            // Sort
            tasks.sort((a, b) => {
                if (sortMode === 'priority') {
                    const order = { 'È´ò': 1, '‰∏≠': 2, '‰Ωé': 3 };
                    return (order[a.priority] || 99) - (order[b.priority] || 99);
                } else if (sortMode === 'group') {
                    return (a.group || '').localeCompare(b.group || '', 'ja');
                } else if (sortMode === 'dueDate') {
                    if (!a.dueDate) return 1;
                    if (!b.dueDate) return -1;
                    return new Date(a.dueDate) - new Date(b.dueDate);
                }
                // default
                return (a.no || 0) - (b.no || 0);
            });

            tasks.forEach(task => {
                const card = createCardElement(task);
                list.appendChild(card);
            });

            // Update count
            list.parentElement.querySelector('.count').innerText = tasks.length;
        });

        document.getElementById('kanban-container').classList.toggle('show-detail', state.showDetail);
    }

    function createCardElement(task) {
        const div = document.createElement('div');
        const priorityClass = `priority-${state.mapping.PRIORITY[task.priority] || 'middle'}`;

        div.className = `task-card ${priorityClass}`;
        div.dataset.id = task.id;
        div.dataset.status = task.status;

        const dateStr = task.dueDate ? new Date(task.dueDate).toLocaleDateString('ja-JP') : '';
        const groupColor = generateColorFromHash(task.group);

        // Check if overdue (only for non-completed tasks)
        let dueDateClass = '';
        if (task.dueDate && task.status !== 'ÂÆå‰∫Ü') {
            const dueDate = new Date(task.dueDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            dueDate.setHours(0, 0, 0, 0);
            if (dueDate < today) {
                dueDateClass = 'overdue';
            }
        }

        const labelSymbol = task.label || '‚òÖ';
        const labelClass = task.label ? 'active' : 'inactive';
        const checkClass = task.status === 'ÂÆå‰∫Ü' ? 'completed' : '';

        div.innerHTML = `
    <div class="card-header-row">
      <span class="card-label ${labelClass}" title="Label">${labelSymbol}</span>
      <div class="card-group" style="background-color: ${groupColor}">${task.group || '„Å™„Åó'}</div>
      <div class="card-title">${task.title}</div>
      <div class="card-due ${dueDateClass}">${dateStr}</div>
      <span class="card-check material-icons ${checkClass}" title="Complete">check_circle</span>
    </div>
    <div class="card-preview"></div>
    <div class="card-content">${task.contentHtml}</div>
`;
        // Process content with icons
        const processedHtml = (task.contentHtml || '').replace(
            /(https?:\/\/[^\s<]+)/g,
            (url) => {
                const icon = getUrlIcon(url);
                return `<a href="${url}" target="_blank" class="url-inline-link" onclick="event.stopPropagation()"><span class="material-icons">${icon}</span>${url}</a>`;
            }
        );
        div.querySelector('.card-content').innerHTML = processedHtml;

        // Preview also gets icons but maybe just as indicators
        const previewText = task.contentRaw || '';
        div.querySelector('.card-preview').innerHTML = previewText.replace(
            /(https?:\/\/[^\s]+)/g,
            (url) => `<span class="material-icons preview-inline-icon">${getUrlIcon(url)}</span>`
        );

        // Add fade-in animation for newly moved tasks
        if (task._justCompleted) {
            div.classList.add('appearing');
            delete task._justCompleted; // Clear flag
        }

        // Label Click
        div.querySelector('.card-label').onclick = (e) => {
            e.stopPropagation();
            const labels = ['‚òÖ', '‚≠ê', '‚ö†Ô∏è', 'üí•', 'ü©∑'];
            // If current is empty or not in list (default star is visual only for empty), assume index 0
            // Actually, if saved value is empty, we show gray star.
            // Sequence: Gray Star (empty) -> ‚≠ê -> ‚ö†Ô∏è -> ...
            // Let's treat '‚òÖ' as empty in logic if it's the gray one, but user wants rotation.
            // If task.label is empty, next is ‚≠ê.
            let currentIdx = labels.indexOf(task.label);
            if (currentIdx === -1) currentIdx = 0; // Default or empty treated as start

            const nextIdx = (currentIdx + 1) % labels.length;
            const nextLabel = labels[nextIdx];

            // Optimistic Update
            task.label = nextLabel === '‚òÖ' ? '' : nextLabel;
            // If '‚òÖ' is the "empty/gray" state, we might save empty string. 
            // User: "Usually gray star, click -> ‚≠ê...". So gray star is default state.

            e.target.innerText = nextLabel;
            e.target.className = `card-label ${task.label ? 'active' : 'inactive'}`;

            google.script.run.withFailureHandler(handleError).saveTask(task);
        };

        // Check Click
        div.querySelector('.card-check').onclick = (e) => {
            e.stopPropagation();

            if (task.status === 'ÂÆå‰∫Ü') {
                // Uncheck: Move back to In Progress
                div.classList.add('completing'); // Fade-out animation
                e.target.classList.remove('completed'); // Remove green immediately

                setTimeout(() => {
                    task.status = 'ÂÆüÊñΩ‰∏≠';
                    task._justCompleted = true; // Flag for fade-in animation
                    renderBoard();
                    google.script.run.withFailureHandler(handleError).saveTask(task);
                }, 700); // Wait for animation
            } else {
                // Check: Move to Done
                div.classList.add('completing');
                e.target.classList.add('completed'); // Green check immediately

                setTimeout(() => {
                    // Move to Done after animation
                    task.status = 'ÂÆå‰∫Ü';
                    task._justCompleted = true; // Flag for fade-in animation
                    renderBoard();
                    google.script.run.withFailureHandler(handleError).saveTask(task);
                }, 700); // Wait for animation
            }
        };

        div.onclick = () => openModal(task);
        return div;

    }

    function setupSortable() {
        const lists = document.querySelectorAll('.task-list');
        lists.forEach(el => {
            Sortable.create(el, {
                group: 'kanban',
                animation: 150,
                ghostClass: 'dragging',
                onEnd: (evt) => {
                    if (evt.from === evt.to && evt.oldIndex === evt.newIndex) return;
                    updateAfterDrag();
                }
            });
        });
    }

    function updateAfterDrag() {
        const updates = [];
        const statusCols = document.querySelectorAll('.kanban-column');

        statusCols.forEach(col => {
            const status = col.dataset.status;
            const cards = col.querySelectorAll('.task-card');
            cards.forEach((card, index) => {
                const id = card.dataset.id;
                const no = index + 1;

                // Update state
                const task = state.tasks.find(t => t.id == id);
                if (task) {
                    task.status = status;
                    task.no = no;
                }

                updates.push({ id, status, no });
            });
        });

        renderBoard();

        google.script.run
            .withFailureHandler(handleError)
            .updateOrderAndStatus(updates);
    }

    function setupResizers() {
        setupColumnResizer('.resizer', '.kanban-column', document.getElementById('kanban-container'));
    }

    function getUrlIcon(url) {
        if (url.includes('mail.google.com')) return 'email';
        if (url.includes('drive.google.com')) return 'folder';
        if (url.includes('calendar.google.com')) return 'calendar_today';
        if (url.includes('meet.google.com')) return 'videocam';
        return 'link';
    }
</script>
<!-- --- END js-kanban-view.html --- -->

    
<!-- --- START js-task-modal.html --- -->
<script>
    /**
     * Task Modal Logic
     */

    function setupTaskModal() {
        // Modal events
        const modal = document.getElementById('taskModal');
        const closeModal = () => modal.classList.remove('show');

        document.querySelector('.close-modal').onclick = closeModal;
        document.querySelector('.cancel-btn').onclick = closeModal;

        document.getElementById('taskForm').onsubmit = (e) => {
            e.preventDefault();
            saveCurrentTask();
        };

        document.getElementById('deleteTaskBtn').onclick = () => {
            if (confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                deleteCurrentTask();
            }
        };

        // Color Picker Logic (integrated with RichTextEditor)
        const colorBtn = document.getElementById('colorBtn');
        const colorMenu = document.getElementById('colorMenu');

        colorBtn.onclick = (e) => {
            e.preventDefault();
            colorMenu.classList.toggle('show');
        };

        document.querySelectorAll('.color-swatch').forEach(swatch => {
            swatch.onclick = (e) => {
                const color = swatch.dataset.color;
                RichTextEditor.applyColor('editor', color);
                colorMenu.classList.remove('show');
                colorBtn.querySelector('.color-bar').style.background = color;
            };
        });

        window.addEventListener('click', (e) => {
            if (!colorBtn.contains(e.target)) colorMenu.classList.remove('show');
        });
    }

    function openModal(task = null) {
        const form = document.getElementById('taskForm');
        const modal = document.getElementById('taskModal');
        const title = document.getElementById('modalTitle');

        form.reset();
        RichTextEditor.clear('editor');
        document.getElementById('deleteTaskBtn').style.display = task ? 'block' : 'none';

        if (task) {
            title.innerText = '„Çø„Çπ„ÇØÁ∑®ÈõÜ';
            document.getElementById('taskId').value = task.id;
            document.getElementById('taskGroupInput').value = task.group;
            document.getElementById('taskPriorityInput').value = task.priority;
            document.getElementById('taskTitleInput').value = task.title;
            RichTextEditor.setHtml('editor', task.contentHtml);
            document.getElementById('taskDueDateInput').value = task.dueDate ? task.dueDate.split('T')[0] : '';
            document.getElementById('taskStatusInput').value = task.status;
        } else {
            title.innerText = 'Êñ∞Ë¶è„Çø„Çπ„ÇØËøΩÂä†';
            document.getElementById('taskId').value = '';
        }

        modal.classList.add('show');
    }

    function saveCurrentTask() {
        const id = document.getElementById('taskId').value;
        const task = {
            id: id,
            group: document.getElementById('taskGroupInput').value,
            priority: document.getElementById('taskPriorityInput').value,
            title: document.getElementById('taskTitleInput').value,
            contentHtml: RichTextEditor.getHtml('editor'),
            contentRaw: RichTextEditor.getRawText('editor'),
            dueDate: document.getElementById('taskDueDateInput').value,
            status: document.getElementById('taskStatusInput').value
        };

        showLoading('loading-overlay', true);
        google.script.run
            .withSuccessHandler(() => {
                document.getElementById('taskModal').classList.remove('show');
                refreshData();
            })
            .withFailureHandler(handleError)
            .saveTask(task);
    }

    function deleteCurrentTask() {
        const id = document.getElementById('taskId').value;
        showLoading('loading-overlay', true);
        google.script.run
            .withSuccessHandler(() => {
                document.getElementById('taskModal').classList.remove('show');
                refreshData();
            })
            .withFailureHandler(handleError)
            .deleteTask(id);
    }
</script>
<!-- --- END js-task-modal.html --- -->

    
<!-- --- START js-main.html --- -->
<script>
    /**
     * Main Client Controller
     */

    const state = {
        tasks: [],
        mapping: {},
        filter: { group: '', priority: '' },
        columnSort: {
            'Êú™ÁùÄÊâã': 'default',
            'ÂÆüÊñΩ‰∏≠': 'default',
            '‰øùÁïô': 'default',
            'ÂÆå‰∫Ü': 'default'
        },
        showDetail: false,
        showDone: false
    };

    // Initial Load
    window.onload = () => {
        showLoading('loading-overlay', true);
        RichTextEditor.init('editor', 'editorToolbar');
        setupEventListeners();
        setupSortable(); // Move potentially static setups here
        setupResizers();
        setupTaskModal();

        // Initial UI State check
        updateDoneVisibility();
        updateDetailButton();

        // Load Data and Settings
        google.script.run
            .withSuccessHandler(initialize)
            .withFailureHandler(handleError)
            .getData();

        google.script.run.withSuccessHandler(settings => {
            state.mapping = settings.mapping;
            document.getElementById('appVersion').innerText = settings.version || '';
        }).getSettings();
    };

    function initialize(data) {
        state.tasks = data;
        updateDataLists();
        renderBoard();
        // Event listeners and static setups moved to window.onload to prevent duplication and state reset
        showLoading('loading-overlay', false);
    }

    function refreshData() {
        google.script.run
            .withSuccessHandler(initialize)
            .withFailureHandler(handleError)
            .getData();
    }

    function updateDataLists() {
        const groups = [...new Set(state.tasks.map(t => t.group).filter(Boolean))];
        const filterSelect = document.getElementById('filterGroup');
        const datalist = document.getElementById('groupOptions');

        // Filter HTML
        const currentFilter = filterSelect.value;
        filterSelect.innerHTML = '<option value="">ÂÖ®„Ç∞„É´„Éº„Éó</option>' +
            groups.map(g => `<option value="${g}" ${g === currentFilter ? 'selected' : ''}>${g}</option>`).join('');

        // Modal Input Candidates
        datalist.innerHTML = groups.map(g => `<option value="${g}">`).join('');
    }

    function setupEventListeners() {
        // Filter
        document.getElementById('filterGroup').onchange = (e) => {
            state.filter.group = e.target.value;
            renderBoard();
        };
        document.getElementById('filterPriority').onchange = (e) => {
            state.filter.priority = e.target.value;
            renderBoard();
        };

        // Column Sort
        document.querySelectorAll('.column-sort').forEach(sel => {
            sel.onchange = (e) => {
                const status = e.target.dataset.status;
                state.columnSort[status] = e.target.value;
                renderBoard();
            };
        });

        // Toggle Detail
        window.updateDetailButton = () => {
            const btn = document.getElementById('toggleDetailBtn');
            if (state.showDetail) {
                btn.innerText = 'Ë©≥Á¥∞ÔºöË°®Á§∫';
                btn.classList.add('primary');
                btn.classList.remove('secondary');
            } else {
                btn.innerText = 'Ë©≥Á¥∞ÔºöÈùûË°®Á§∫';
                btn.classList.remove('primary');
                btn.classList.add('secondary');
            }
        };
        document.getElementById('toggleDetailBtn').onclick = () => {
            state.showDetail = !state.showDetail;
            updateDetailButton();
            renderBoard();
        };

        // Toggle Done Column
        const doneColumn = document.querySelector('.kanban-column[data-status="ÂÆå‰∫Ü"]');

        window.updateDoneVisibility = () => {
            const btn = document.getElementById('toggleDoneBtn');
            // Reset widths
            document.querySelectorAll('.kanban-column').forEach(col => {
                col.style.width = '';
                col.style.flex = '1 1 0';
            });

            if (state.showDone) {
                doneColumn.classList.remove('hidden');
                btn.innerText = 'ÂÆå‰∫ÜÔºöË°®Á§∫';
                btn.classList.add('primary');
                btn.classList.remove('secondary');
            } else {
                doneColumn.classList.add('hidden');
                btn.innerText = 'ÂÆå‰∫ÜÔºöÈùûË°®Á§∫';
                btn.classList.remove('primary');
                btn.classList.add('secondary');
            }
        };

        document.getElementById('toggleDoneBtn').onclick = () => {
            state.showDone = !state.showDone;
            window.updateDoneVisibility();
        };

        // Add Task
        document.getElementById('addTaskBtn').onclick = () => openModal();

        // Import Google Tasks
        document.getElementById('importTasksBtn').onclick = () => {
            document.getElementById('dropdownMenu').classList.remove('show');
            showLoading('loading-overlay', true);
            google.script.run
                .withSuccessHandler(res => {
                    refreshData();
                    alert(`${res.count} ‰ª∂„ÅÆ„Çø„Çπ„ÇØ„ÇíÊäΩÂá∫„Åó„Åæ„Åó„Åü„ÄÇ`);
                })
                .withFailureHandler(handleError)
                .importFromGoogleTasks();
        };

        // Menu Toggle
        const menuTrigger = document.getElementById('menuTrigger');
        const dropdownMenu = document.getElementById('dropdownMenu');
        menuTrigger.onclick = (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
        };
        window.onclick = () => {
            dropdownMenu.classList.remove('show');
        };
    }

    function handleError(err) {
        showLoading('loading-overlay', false);
        alert('Error: ' + err.message);
        console.error(err);
    }
</script>
<!-- --- END js-main.html --- -->

</body>

</html>